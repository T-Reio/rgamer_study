---
title: "rgamer"
author: "tj_chann"
date: "2024-03-01"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    theme: "journal"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(pacman)
p_load(tidyverse)
p_load(rgamer)
```

# Rで学ぶゲーム理論 {-}

# Rで体感するゲーム理論

## ゲーム理論の伝統的な学習法

- 紙の上で概念や計算を学ぶ
  - 数学的に容易な内容から始まり、数学的な難易度が初級・上級の別も決めてしまう
  - 社会科学の汎用的な分析道具であり、社会実践上様々な知見を提供するようになった現在を鑑みると問題
    - 数学的な取り扱いの難しさが、重要なトピックの説明を妨げる

こうした問題に対処するために、理論的な命題を実践をもって確認する必要
  - 例えば統計学では、コイン投げの試行を実際に繰り返し行うことで、表が出る確率が.5に収束していく様を確認できる
```{r prelim_coin_toss}
results <- c("T", "B")
result_table <- map_df(
  1:3,
  ~ tibble(
    stage = .x,
    result = sample(results, 1000, replace = T, prob = c(.5, .5))
  ) %>% 
    mutate(trial = row_number())
) %>% 
    group_by(stage) %>% 
    mutate(
      freq = cumsum(result == "T"), # 表が出た累積回数
      cum_average = freq / trial, # 累積比率
    )

ggplot(result_table) +
  aes(x = trial, y = cum_average, group = as.factor(stage), colour = as.factor(stage)) +
  geom_path() +
  geom_point() +
  geom_hline(yintercept = .5, linetype = "dashed") +
  theme_bw() +
  labs(x = "試行回数", y = "平均", fill = "ステージ", colour = "ステージ") +
  theme(text = element_text(size = 12))
```
  
  - `rgamer`パッケージの考案
    - ゲームを自動的に解き、可視化する

## ゲームを定義する

マッチングペニーの例を用いて、基本的な操作を紹介する

### 標準形ゲームの定義
- 要件
  - players
  - strategies
  - payoffs
```{r 1_1_1}
game1 <- rgamer::normal_form(
  players = c("Ore", "Are"), # プレイヤー
  s1 = c("top", "bottom"), # 戦略
  s2 = c("top", "bottom"),
  payoffs1 = c(1, 0, 0, 1), # 利得
  payoffs2 = c(0, 1, 1, 0),
)
```

### 利得表の表示
- 定義されたゲームの利得表を作成
```{r 1_2_1, results='hide'}
g1_sol <- solve_nfg(game1) # normal_form_game
# 純粋戦略のナッシュ均衡が存在しない
```
  
### ナッシュ均衡を求める

- 全てのプレイヤーについて、合理的な個人ならば、それ以上選択の余地がないと認められる状況
  - self-commitment
- マッチングペニーの例の場合
  - Pure strategy NE does not exit.
  - You can show the mixed strategy Nash Equilibrium.
```{r 1_3_1, results='hide'}
g1_sol2 <- solve_nfg(game1, mixed = TRUE)
```

```{r 1_3_2}
g1_sol2$table #htmlに表示するにはこうする必要があるらしい
```


### 最適反応の表示

- best responsesには利得表で`^`が表示される
  - 2人のプレイヤーの両方の戦略が互いに最適反応となるような戦略の組があれば、それが純粋戦略のNEになる
  - 相手の戦略を所与としたときの、自身の最適反応を示すプロット
  
```{r 1_4_1}
g1_sol2$br_plot
```
  
  - P2には、P1が$\{(1/2, 1/2\}$の混合戦略を取るときのみ、混合戦略を取るインセンティブがある

#### シミュレーションの結果を眺める

- `rgamer`は特定のゲームに対する標準的な分析を自動で行うだけではなく、特定の意思決定ルールに従う個人が、そのゲームにおいてどのように振舞うのかをシミュレーションすることができる

```{r 1_5_1}
g1_sim <- sim_game(
  game1, # normal_formで定義したgameオブジェクト
  n_samples = 100, # iterationの数（ゲームをプレーする個人の組）
  n_periods = 50 # 一つの組がプレーするゲームの数
)
g1_sim
```
  - 100人の「Ore」のうち、何人が表/裏を選択したか→50ピリオド分

### その他の機能

- extensive form game
  - ゲームの木の描画
  - backward inductionやsubgame perfect equilibriumの導出
- matching
  - deferred acceptance algorithm
  - Boston algorithm
  - 安定マッチングの判定
  
# ゲームの定義と合理的なプレーヤー

**標準形ゲームの基礎**

- 人々が同時に意思決定するような状況
  - じゃんけん
- 標準形ゲームの三要素
  - プレイヤー
  - 戦略
  - 利得

## ゲーム的状況

- 環境：**外的な条件**との**相互依存関係**
  - 人間の生活は外的な環境に強く影響を受けている（自然災害）
  - 一方で、環境に対して大きな影響を与えるのも人間（水害対策としてのダム建設）
- 同様に、社会経済環境に対しても、相互依存的な関係を持つ
  - 景気の動向が人々の進路を決定（不況時に医療系学部への進学が選ばれる）
  - 人々の選択の集積が新たな環境を作る（医療系の倍率が上がる）
  
ゲーム理論の目的の一つが、**人間と社会の相互作用の分析**

- 社会経済環境においては、相互作用の相手たる社会が人間によって構成されている
  - 複数のプレーヤーの戦略の読みあいが存在
  - 相手の行動・選択が分かれば、それに応じて自身の行動や選択を修正できる
- **ゲーム的状況** (戦略的状況、戦略的相互依存関係)
  - 複数人の意思決定の相互作用
- 典型的には2人のゲームを記述するが、一般に拡張しても、結果は変わらないことが多い

## ゲームの定義

### 標準形ゲーム

**標準形ゲームの三要素**
1. Player
2. Strategies
3. Payoffs

- マッチングペニーの例
  - 2人のプレーヤーが同時にコインの裏表を決めてそれを見せ合い、一致すれば一方が、しなければもう一方が勝利するゲーム
  - ゲームの定義
    - プレイヤー：2人 A, B
    - 戦略は表、裏の2つから一方
    - 上記の勝敗決定法に基づき、勝った方が利得1を得、もう一方は何も得られない(利得ゼロ)
    
これを`rgamer`で定義

```{r 2_2_1}
game2_1 <- rgamer::normal_form(
  players = c("A", "B"), # プレイヤー
  s1 = c("top", "bottom"), # 戦略
  s2 = c("top", "bottom"),
  payoffs1 = c(1, 0, 0, 1), # 利得
  payoffs2 = c(0, 1, 1, 0),
)
```

- `players`, `s*`, `payoffs*`がそれぞれゲームのプレーヤー、戦略、利得に対応している

## 利得表を用いた表現

- ゲームの定義を直感的に理解するための表現として、**利得表**が用いられる

```{r 2_3_1, results='hide'}
g2_1_sol <- solve_nfg(game2_1)
```

```{r 2_3_2}
g2_1_sol$table
```

- 行プレーヤー、列プレーヤーなる表現があるらしい。へえ。

## じゃんけんの定義

- 最も身近な標準形ゲーム
  - 2人のじゃんけん
  - payoffは勝ちが2, 引分1, 負け0とする
  
```{r 2_4_1}
game2_2 <- rgamer::normal_form(
  players = c("千葉", "福岡"), # プレイヤー
  s1 = c("グー", "チョキ", "パー"), # 戦略
  s2 = c("グー", "チョキ", "パー"),
  payoffs1 = c(
    1, 0, 2,
    2, 1, 0,
    0, 2, 1
  ), # 利得
  payoffs2 = c(
    1, 2, 0, # 利得表の順番おかしいだろ
    0, 1, 2, # 1行1列→3行1列、1行2列→3行2列、...
    2, 0, 1
  ),
)
```

```{r 2_4_2, results='hide'}
g2_2_sol <- solve_nfg(game2_2)
```

```{r 2_4_3}
g2_2_sol$table
```

