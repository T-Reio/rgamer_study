---
title: "rgamer"
author: "tj_chann"
date: "2024-03-01"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    #theme: "paper"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(pacman)
p_load(tidyverse)
p_load(rgamer)
p_load(kableExtra)
p_load(knitr)
p_load(tinytable)
```

# Rで学ぶゲーム理論 {-}

# Rで体感するゲーム理論

## ゲーム理論の伝統的な学習法

- 紙の上で概念や計算を学ぶ
  - 数学的に容易な内容から始まり、数学的な難易度が初級・上級の別も決めてしまう
  - 社会科学の汎用的な分析道具であり、社会実践上様々な知見を提供するようになった現在を鑑みると問題
    - 数学的な取り扱いの難しさが、重要なトピックの説明を妨げる

こうした問題に対処するために、理論的な命題を実践をもって確認する必要
  - 例えば統計学では、コイン投げの試行を実際に繰り返し行うことで、表が出る確率が.5に収束していく様を確認できる
```{r prelim_coin_toss}
results <- c("T", "B")
result_table <- map_df(
  1:3,
  ~ tibble(
    stage = .x,
    result = sample(results, 1000, replace = T, prob = c(.5, .5))
  ) %>% 
    mutate(trial = row_number())
) %>% 
    group_by(stage) %>% 
    mutate(
      freq = cumsum(result == "T"), # 表が出た累積回数
      cum_average = freq / trial, # 累積比率
    )

ggplot(result_table) +
  aes(x = trial, y = cum_average, group = as.factor(stage), colour = as.factor(stage)) +
  geom_path() +
  geom_point() +
  geom_hline(yintercept = .5, linetype = "dashed") +
  theme_bw() +
  labs(x = "試行回数", y = "平均", fill = "ステージ", colour = "ステージ") +
  theme(text = element_text(size = 12))
```
  
  - `rgamer`パッケージの考案
    - ゲームを自動的に解き、可視化する

## ゲームを定義する

マッチングペニーの例を用いて、基本的な操作を紹介する

### 標準形ゲームの定義
- 要件
  - players
  - strategies
  - payoffs
```{r 1_1_1}
game1 <- rgamer::normal_form(
  players = c("Ore", "Are"), # プレイヤー
  s1 = c("top", "bottom"), # 戦略
  s2 = c("top", "bottom"),
  payoffs1 = c(1, 0, 0, 1), # 利得
  payoffs2 = c(0, 1, 1, 0),
)
```

### 利得表の表示
- 定義されたゲームの利得表を作成
```{r 1_2_1, results='hide'}
g1_sol <- solve_nfg(game1) # normal_form_game
# 純粋戦略のナッシュ均衡が存在しない
```
  
### ナッシュ均衡を求める

- 全てのプレイヤーについて、合理的な個人ならば、それ以上選択の余地がないと認められる状況
  - self-commitment
- マッチングペニーの例の場合
  - Pure strategy NE does not exit.
  - You can show the mixed strategy Nash Equilibrium.
```{r 1_3_1, results='hide'}
g1_sol2 <- solve_nfg(game1, mixed = TRUE)
```

```{r 1_3_2}
g1_sol2$table #htmlに表示するにはこうする必要があるらしい
```


### 最適反応の表示

- best responsesには利得表で`^`が表示される
  - 2人のプレイヤーの両方の戦略が互いに最適反応となるような戦略の組があれば、それが純粋戦略のNEになる
  - 相手の戦略を所与としたときの、自身の最適反応を示すプロット
  
```{r 1_4_1}
g1_sol2$br_plot
```
  
  - P2には、P1が$\{(1/2, 1/2\}$の混合戦略を取るときのみ、混合戦略を取るインセンティブがある

#### シミュレーションの結果を眺める

- `rgamer`は特定のゲームに対する標準的な分析を自動で行うだけではなく、特定の意思決定ルールに従う個人が、そのゲームにおいてどのように振舞うのかをシミュレーションすることができる

```{r 1_5_1}
g1_sim <- sim_game(
  game1, # normal_formで定義したgameオブジェクト
  n_samples = 100, # iterationの数（ゲームをプレーする個人の組）
  n_periods = 50 # 一つの組がプレーするゲームの数
)
g1_sim
```
  - 100人の「Ore」のうち、何人が表/裏を選択したか→50ピリオド分

### その他の機能

- extensive form game
  - ゲームの木の描画
  - backward inductionやsubgame perfect equilibriumの導出
- matching
  - deferred acceptance algorithm
  - Boston algorithm
  - 安定マッチングの判定
  
# ゲームの定義と合理的なプレイヤー

**標準形ゲームの基礎**

- 人々が同時に意思決定するような状況
  - じゃんけん
- 標準形ゲームの三要素
  - プレイヤー
  - 戦略
  - 利得

## ゲーム的状況

- 環境：**外的な条件**との**相互依存関係**
  - 人間の生活は外的な環境に強く影響を受けている（自然災害）
  - 一方で、環境に対して大きな影響を与えるのも人間（水害対策としてのダム建設）
- 同様に、社会経済環境に対しても、相互依存的な関係を持つ
  - 景気の動向が人々の進路を決定（不況時に医療系学部への進学が選ばれる）
  - 人々の選択の集積が新たな環境を作る（医療系の倍率が上がる）
  
ゲーム理論の目的の一つが、**人間と社会の相互作用の分析**

- 社会経済環境においては、相互作用の相手たる社会が人間によって構成されている
  - 複数のプレイヤーの戦略の読みあいが存在
  - 相手の行動・選択が分かれば、それに応じて自身の行動や選択を修正できる
- **ゲーム的状況** (戦略的状況、戦略的相互依存関係)
  - 複数人の意思決定の相互作用
- 典型的には2人のゲームを記述するが、一般に拡張しても、結果は変わらないことが多い

## ゲームの定義

### 標準形ゲーム

**標準形ゲームの三要素**
1. Player
2. Strategies
3. Payoffs

- マッチングペニーの例
  - 2人のプレイヤーが同時にコインの裏表を決めてそれを見せ合い、一致すれば一方が、しなければもう一方が勝利するゲーム
  - ゲームの定義
    - プレイヤー：2人 A, B
    - 戦略は表、裏の2つから一方
    - 上記の勝敗決定法に基づき、勝った方が利得1を得、もう一方は何も得られない(利得ゼロ)
    
これを`rgamer`で定義

```{r 2_2_1}
game2_1 <- rgamer::normal_form(
  players = c("A", "B"), # プレイヤー
  s1 = c("top", "bottom"), # 戦略
  s2 = c("top", "bottom"),
  payoffs1 = c(1, 0, 0, 1), # 利得
  payoffs2 = c(0, 1, 1, 0),
)
```

- `players`, `s*`, `payoffs*`がそれぞれゲームのプレイヤー、戦略、利得に対応している

## 利得表を用いた表現

- ゲームの定義を直感的に理解するための表現として、**利得表**が用いられる

```{r 2_3_1, results='hide'}
g2_1_sol <- solve_nfg(game2_1)
```

```{r 2_3_2}
g2_1_sol$table
```

- 行プレイヤー、列プレイヤーなる表現があるらしい。へえ。

## じゃんけんの定義

- 最も身近な標準形ゲーム
  - 2人のじゃんけん
  - payoffは勝ちが2, 引分1, 負け0とする
  
```{r 2_4_1}
game2_2 <- rgamer::normal_form(
  players = c("千葉", "福岡"), # プレイヤー
  s1 = c("グー", "チョキ", "パー"), # 戦略
  s2 = c("グー", "チョキ", "パー"),
  payoffs1 = c(
    1, 0, 2,
    2, 1, 0,
    0, 2, 1
  ), # 利得
  payoffs2 = c(
    1, 2, 0, # 利得表の順番おかしいだろ
    0, 1, 2, # 1行1列→3行1列、1行2列→3行2列、... Rのdata.frameと同じフォーマットってことか
    2, 0, 1 # 行優先の定義にも変更可能：早く言え
  ),
)
```

```{r 2_4_2, results='hide'}
g2_2_sol <- solve_nfg(game2_2)
```

```{r 2_4_3}
g2_2_sol$table
```

## プレイヤーの合理性

- 定義したゲームの分析方法を考える
- プレイヤーの選択を分析するためには、仮定されるプレイヤーの性質について議論する必要がある
  - 常にサイコロを振って戦略を決定するようなプレイヤーに分析は必要ない
  
**合理的なプレイヤー**

- 合理的なプレイヤーを仮定することに対するexcuse
  
  - 積極的な側面：人々の実際の意思決定により近い選好
  
  - 消極的な側面：非合理性を仮定した解析は合理性を仮定しないそれよりも煩雑で困難だから

- 合理的なプレイヤーの条件として要求される合理性は、状況によって異なる

  - プレイヤーは自身の置かれているゲーム的状況を正確人把握している

    - 自身だけでなく、相手の立場についても理解している

  - プレイヤーは自身の利得を最大化するために必要な能力を有している

    - 計算能力や記憶力、先を読む能力

- 分析の目的に応じて仮定する合理性の程度を変えていく

  - 人間の実際の意思決定からかけ離れた極端な仮定や、分析結果に何の示唆もないような緩い仮定を避ける

    - partial identificationっぽいね

- `rgamer`など、計算機を使った分析を行うことで、非合理性にも対処できるように

  - 選好の系統的な特性を組み込む行動経済学・実験経済学のアクションも含まれる
  
# 支配戦略と支配される戦略の繰り返し消去

**keyword**: 支配される戦略；支配される戦略の逐次消去、支配戦略

- `normal_form()`, `solve_nfg()`, `dom()`, `eliminate_strategy()`

**戦略の支配関係**

- 一般的に、戦略的状況においては、ゲームの結果に関して、相手の選択に依存した不確実性が存在する

- 一方で、自身の合理的な選択が相手の行動に対する予測とは無関係に定まる場合もある：戦略間の支配関係
  
  - ある戦略がそれ以外よりも常に優れていた李、常に劣っていたりするような関係
  
  - 自身の戦略だけでなく、相手の戦略について検討することで、相手の行動に対する予測にも使用できる
  
  - 互いが互いの戦略に対する予測を行うことで、両者の取りうる戦略が単一の組に定まることも
  
## 不平等なじゃんけん

- 2.4節のじゃんけんの例

  - 答えは一概に定まらない
    - 人間の選択の癖までモデルに組み込めば状況が変わる可能性もあるが
  
  - それぞれの選択肢について、**それを選択するのが好ましい場面が存在**
    - 同様に、どのような状況においても不要な戦略は存在しない
    
- 変わったじゃんけん
  - あいこの場合の勝者を定める
    - グー、チョキであいこになった場合は千葉が、パーの場合は福岡が勝利する
    - 千葉の方が勝利条件が多い
  
```{r 3_1_1, results='hide'}
game_3_1 <- normal_form(
  players = c("千葉", "福岡"), # プレイヤー
  s1 = c("グー", "チョキ", "パー"), # 戦略
  s2 = c("グー", "チョキ", "パー"),
  payoffs1 = c(
    1, 1, 0,
    0, 1, 1,
    1, 0, 0
  ),
  payoffs2 = c(
    0, 0, 1,
    1, 0, 0,
    0, 1, 1
  ),
  byrow = T
)
tmp <- solve_nfg(game_3_1)
```
```{r, 3_1_2}
tmp %>% {.[["table"]]}
```

- ゲームの結果の考察
  
  - 千葉は5/9、福岡は4/9の戦略の組み合わせで勝利する
    
    - 千葉の勝利オッズは $\frac{5/9}{4/9} = 1.25$ 倍？
    
    - もっともらしい思考だが、ゲーム理論的ではない

### 無駄な戦略の消去
  
- 福岡の戦略
    
  - パーは通常のじゃんけんと同じく相手のグーに勝てるだけでなく、相手がパーを出した時にも勝利することができる
    
  - 相手がチョキを出した時に負けるのはチョキも同じ
    
  このとき、パーとチョキとを比較すると、常にパーの方がチョキと同等、もしくはそれよりも望ましい結果を生み出している：チョキが不要な戦略であることがわかる weakly dominated strategy
      
  - 利得表からも読み取れる
  
- 利得表の書き直し

  - 福岡にとってチョキが不要な戦略であると分かったので、利得表からもこれを省いてよい
  
```{r 3_1_3, results='hide'}
game_3_1_1 <- normal_form(
  players = c("千葉", "福岡"), # プレイヤー
  s1 = c("グー", "チョキ", "パー"), # 戦略
  s2 = c("グー", "パー"),
  payoffs1 = c(
    1, 0,
    0, 1,
    1, 0
  ),
  payoffs2 = c(
    0, 1,
    1, 0,
    0, 1
  ),
  byrow = T
)
tmp <- solve_nfg(game_3_1_1)
```

```{r 3_1_4, echo=F}
tmp$table
```

- 修正した利得表によると、両者が勝てる戦略の組み合わせはそれぞれ3通りずつ：一見不公平に見えるが、弱く支配される戦略を取り除くとその実公平なゲームが現れる

### 合理的な推論に基づくゲームの変形

- ゲーム的状況において、プレイヤーが取る戦略を決めるのはプレイヤー自身であり、常にすべてのアウトカムが等確率で起こるわけではない
  
  - すべての結果が起こりうると考える誤った推論は、結果として誤った結論を導く

- 戦略間の優劣関係を検討して修正されたゲームの中で、残された選択肢に再度優劣関係の検討を与えることもできる

## Dominated Strategy

- weakly dominated strategy
  
  - 「弱」は等号成立を含める
  
  - Let define $\pi(s)$ be the payoff function of player $i$. For any strategy $s_i$ and $s_j$, if
    
    $$
    \pi(s_i) \leq \pi(\bar{s}),
    $$
    holds, then strategy $s_i$ is weakly dominated by $s_j$.
    
### 戦略の支配関係

- 4つのゲームを定義する

```{r 3_3_1, echo=F, fig.align='center'}

game3_0 <- list()

game3_0[[1]] <- tribble(
  ~ "", ~"L", ~ "C", ~"R",
  "T", 2, 0, 0,
  "B", 0, 0, 0,
)
game3_0[[2]] <- tribble(
  ~ "", ~"L", ~ "C", ~"R",
  "T", 2, 2, 0,
  "B", 0, 0, 0,
)
game3_0[[3]] <- tribble(
  ~ "", ~"L", ~ "C", ~"R",
  "T", 2, 2, 2,
  "B", 0, 0, 0,
)

game3_0[[4]] <- tribble(
  ~ "", ~"L", ~ "C", ~"R",
  "T", 2, 1, 0,
  "B", 2, 1, 0,
)

# めんどいからこれでいいや、なんか思いついたらきれいにする
kable(game3_0[[1]], caption = "(a)") %>% kable_styling()
kable(game3_0[[2]], caption = "(b)") %>% kable_styling()
kable(game3_0[[3]], caption = "(c)") %>% kable_styling()
kable(game3_0[[4]], caption = "(d)") %>% kable_styling()
```

